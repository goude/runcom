#!/bin/bash
source "$HOME/.homesick/repos/yaprox/yaprox.sh"

msg=''

network_ok=1
notify_data=$(curl -s https://notify.goude.se/getall) || network_ok=0

if [[ $network_ok == 1 ]]; then
  weather=$(echo "$notify_data" | jq '.weather')
  temp=$(echo $weather | jq '.data.main.temp' | xargs printf "%.*f°C" 0)
  wind=$(echo $weather | jq '.data.wind.speed' | xargs printf "%.*f m/s" 0)

  picomon_age=$(printf '%s' "$notify_data" | jq '."picomon-ok-all".age' | xargs printf "%.*f" 0)
  picomon_ok_all=$(printf '%s' "$notify_data" | jq '."picomon-ok-all".data' | xargs printf "%s")
  picomon_ok_primary=$(printf '%s' "$notify_data" | jq '."picomon-ok-primary".data' | xargs printf "%s")
  pic_reason=""
  (( $picomon_age < 305 )) && pic_age='●' || { pic_age='○'; pic_reason+=' STALE DATA'; }
  [[ $picomon_ok_primary == "True" ]] && pic_pri='●' || { pic_pri='○';pic_reason+=' PRIMARY FAIL'; }
  [[ $picomon_ok_all == "True" ]] && pic_all='●' || { pic_all='○';pic_reason+=''; }

  msg=$(echo $temp $wind $pic_age$pic_pri$pic_all$pic_reason)
else
  msg=$(echo "NO NETWORK")
fi

if [[ -f ~/TODO ]]; then
  msg+=' '
  msg+=$(head -n1 ~/TODO)
  #msg+=$(shuf -n1 ~/.reminders)
fi

echo $msg
